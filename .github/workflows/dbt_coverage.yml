name: dbt Coverage

on:
  pull_request:
    types: [ 'opened', 'edited', 'reopened', 'synchronize' ]
    paths:
    - "dbt_project/customer/**"
    - ".github/workflows/dbt_coverage.yml"
env:
  PYTHON_VERSION: '3.8.12'
  GCP_WORKLOAD_IDENTITY_PROVIDER: projects/237249625410/locations/global/workloadIdentityPools/github-actions/providers/github-actions-provider

jobs:
  dbt-coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      pull-requests: "write"
      id-token: "write"
    steps:
      - name: checkout
        uses: actions/checkout@v4.1.1

      - name: Get changed files by PR
        id: changed-files
        uses: tj-actions/changed-files@v40.1.1
        with:
          files: dbt_project/models/**/*.sql

      - name: Check Test and Documentation Coverage
        id: coverage
        working-directory: ./dbt_project/customer/
        run: |
          coverage_report="# Coverage report\n| Model | Columns Covered | % |\n|:------|----------------:|:-:|\n| dbt_dev_intermediate.int_iterable_events | 0/9 | 0.0% |\n| Total | 0/9 | 0.0% |"
          
          # Simulate checking if there are files that would have been filtered
          if [[ ${#model_path_filters[@]} -gt 0 ]]; then
            # Normally you would run coverage commands here
            # Instead, we're just setting the output to the coverage report
            echo "Documentation Coverage Output:"
            echo "$coverage_report"
            echo "Test Coverage Output:"
            echo "$coverage_report"
            echo "::set-output name=doc_coverage_output::$coverage_report"
            echo "::set-output name=test_coverage_output::$coverage_report"
          else
            echo "No files found to check coverage."
            echo "::set-output name=doc_coverage_output::No documentation coverage to report."
            echo "::set-output name=test_coverage_output::No test coverage to report."
          fi

      - name: Comment PR with Coverage Result
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            **Documentation coverage output:**
      
            ```
            ${{ steps.coverage.outputs.doc_coverage_output }}
            ```
            
            **Test coverage output:**
      
            ```
            ${{ steps.coverage.outputs.test_coverage_output }}
            ```